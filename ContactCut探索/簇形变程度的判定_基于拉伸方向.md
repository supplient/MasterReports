我们使用文献1中的cluster-based shape-matching方法来构造柔体，而solver用的是flex，所以如果想要判定每个簇(cluster)的形变程度的话，首先要看下flex里是怎么处理rigid body的。根据文献2，它用的方法就是shape-matching方法。

我们每个阶段可以从flex那里得到各粒子的deformed positions（形变后位移），并且对柔体建模的时候我们就存下来各粒子的rest positions（形变前位移）。利用这两个量就足以判定簇的形变程度了，下面进行推导。

# Defination
Let the *i*th particle's deformed position to be $x^*_i$(column vector), and its rest position to be $r^*_i$

Use $\overline{x^*}$ for the means of $x^*_i$: $\overline{x^*} = \frac{1}{n} \sum_i x^*_i$.
And the same for $\overline{r^*} = \frac{1}{n} \sum_i r^*_i$

Let $x_i = x^*_i - \overline{x^*}$, and $x = \begin{bmatrix}
	x_1, x_2, \cdots, x_n
\end{bmatrix}$. And the same for $r_i, r$

Now $x, r$ are zero-mean random variables. This feature will be used later.


# Goal Position
The magnitude of deformation using shape-matching method can be define as the stretch extent between the deformed position and the goal position.

In shape-matching method, the goal position is computed as(refer to literature 1):

$$
	g_i = Rr_i
$$

$R$ is the result of polar decomposition on the best transformation $A = RS$. And $A$ is computed by minimize the least square sum:

$$
\min_A \sum_i m_i(Ar_i - x_i)^2
$$

where $m_i$ is the mass of *i*th particle. Derivates the expression:

$$
\begin{aligned}
	\frac{\partial(\sum_i m_i(Ar_i - x_i)^2)}{\partial A} \\
	= \sum_i 2m_i (Ar_i - x_i)r_i^T
\end{aligned}
$$

Let it to be zero, we can solve $A$:

$$
\begin{aligned}
	A &= \sum_i(x_ir_i^T)(\sum_i(r_ir_i^T))^{-1} \\
	&= xr^T(rr^T)^{-1}
\end{aligned}
$$

Note, $x, r$ are zero-based random variables, so the covariance between them is:

$$
	Cov(x, r) = \sum_i(x_ir_i^T)
$$

And the variance of $r$ is:
$$
	Cov(r, r) = \sum_i(r_i r_i^T)
$$

So $A$ in another form can be:

$$
	A = Cov(x, r) Cov(r,r)^{-1}
$$

This is why the literature 2 uses the covariance matrix for the calcualtion of best rotation. The using of 'covariance matrix' may be ambiguous, since the covariance matrix always refer to the matrix of covariances between two sets of random variables. However, in literature 2, they are just using the covariance between $x$ and $r$, which is a matrix.


# The magnitude of stretch
Now we have the best transformation $A$ containing rotation and scaling.

Refer to the literature 3 and [my blog](https://zhuanlan.zhihu.com/p/397600286), we know the singular values of $A$ are the magnitudes of stretch and the right-singular vectors are the stretch directions.








# 参考文献
1. 2005 Meshless Deformations Based on Shape Matching
2. 2014 Unified particle physics for real-time applications
3. 2016 Ductile Fracture for Clustered Shape Matching